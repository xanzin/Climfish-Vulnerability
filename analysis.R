## Download expert answers as .csv
xan <- read.csv ("Vulnerability assessment Xan - Data.csv")
francisco <- read.csv ("Vulnerability assessment Francisco - Data.csv")
eudriano <- read.csv ("Vulnerability assessment Eudriano - Data.csv")
vania <- read.csv ("Vulnerability assessment Vania - Data.csv")
karim <- read.csv ("Vulnerability assessment Karim - Data.csv")
miguel <- read.csv ("Vulnerability assessment Miguel - Data.csv")
daniela <- read.csv ("Vulnerability assessment Daniela2 - Data.csv")
joao    <- read.csv ("Vulnerability assessment Joao - Data.csv")
pedro   <- read.csv ("Vulnerability assessment Pedro - Data.csv")
henrique   <- read.csv ("Vulnerability assessment Henrique - Data.csv")

## Create table with all evaluations
todo <- cbind(xan,
              francisco[5:ncol(francisco)],
              eudriano [5:ncol(eudriano)],
              vania    [5:ncol(vania)],
              karim    [5:ncol(karim)],
              miguel   [5:ncol(miguel)],
              daniela  [5:ncol(daniela)],
              joao     [5:ncol(joao)],
              pedro    [5:ncol(pedro)],
              henrique    [5:ncol(henrique)])


expertos <- c (rep ("Juan", ncol(xan)),
               rep ("Francisco", ncol(francisco)-4),
               rep ("Eudriano", ncol(eudriano)-4),
               rep ("Vania", ncol(vania)-4),
               rep ("Karim", ncol(karim)-4),
               rep ("Miguel", ncol(miguel)-4),
               rep ("Daniela", ncol(daniela)-4),
               rep ("Joao", ncol(joao)-4),
               rep ("Pedro", ncol(pedro)-4),
               rep ("Henrique", ncol(henrique)-4))

length(expertos) == ncol(todo)


## Define scores to give to low, intermediate and high:
scores             <- c(1,2,3)
scores.directional <- c(-1,0,1) ## meter 1,2,3

## Define descriptors
descriptores <- c("SST", "Currents", "pH", "Salinity", "Events", "Riverflow", "PP",
                  "TL", "Fecundity", "Semelparity", "Egg", "Bertalanffy", "Maturity", "r",
                  "Longevity", "Gonochorism", "Spawning", "PLD", "Latitude", "Temperature", "Mobility",
                  "Migrations", "Sociability", "Strategy",
                  "ICES", "Replenishment", "IUCN", "Fisheries", "Pressure",
                  "Directional")

Exposure    <- c("SST", "Currents", "pH", "Salinity", "Events", "Riverflow", "PP")
Sensitivity <- c( "TL", "Fecundity", "Semelparity", "Egg", "Bertalanffy", "Maturity", "r",
                 "Longevity", "Gonochorism", "Spawning", "PLD", "Latitude", "Temperature", "Mobility",
                 "Migrations", "Sociability", "Strategy")
length(Sensitivity)
Adaptive    <- c( "ICES", "Replenishment", "IUCN", "Fisheries", "Pressure")

categorias   <- c("Exposure", "Exposure", "Exposure", "Exposure", "Exposure", "Exposure", "Exposure",
                  "Sensitivity", "Sensitivity", "Sensitivity", "Sensitivity", "Sensitivity",
                  "Sensitivity", "Sensitivity", "Sensitivity", "Sensitivity", "Sensitivity",
                  "Sensitivity", "Sensitivity", "Sensitivity", "Sensitivity", "Sensitivity",
                  "Sensitivity", "Sensitivity",
                  "Adaptive", "Adaptive", "Adaptive", "Adaptive", "Adaptive",
                  "Directional")

## Weights of exposure variables
tablon <- read.csv ("~/CCMAR/JUAN/CLIMFISH/VULNERABILITY/ExposureWeightsNOVO.csv")
head(tablon)

expositors.north45 <- tablon$multiplier.final [
                             c (which(tablon$nombres.indicadores=="SSTrcp4.5 N"), # sst
                                which(tablon$nombres.indicadores=="ECurrentrcp4.5 N"), # currents EAST
                                which(tablon$nombres.indicadores=="PHrcp4.5 N"), # ph
                                which(tablon$nombres.indicadores=="Salinityrcp4.5 N"), # salinity
                                NA, # extreme OJOOOOOOOOOOOOOOOOOOOOOO
                                which(tablon$nombres.indicadores=="Riverrcp4.5 N"), # river
                                which(tablon$nombres.indicadores=="PLANKTONrcp4.5 N"))] # plankton
expositors.north45 [which(is.na(expositors.north45))] <- 1

expositors.north85 <- tablon$multiplier.final [
                             c (which(tablon$nombres.indicadores=="SSTrcp8.5 N"), # sst
                                which(tablon$nombres.indicadores=="Ecurrentrcp8.5 N"), # currents EAST
                                which(tablon$nombres.indicadores=="PHrcp8.5 N"), # ph
                                which(tablon$nombres.indicadores=="Salinityrcp8.5 N"), # salinity
                                NA, # extreme
                                which(tablon$nombres.indicadores=="Riverrcp8.5 N"), # river
                                which(tablon$nombres.indicadores=="PLANKTONrcp8.5 N"))] # plankton
expositors.north85 [which(is.na(expositors.north85))] <- 1

expositors.centre45 <- tablon$multiplier.final [
                             c (which(tablon$nombres.indicadores=="SSTrcp4.5 C"), # sst
                                which(tablon$nombres.indicadores=="ECurrentrcp4.5 C"), # currents EAST
                                which(tablon$nombres.indicadores=="PHrcp4.5 C"), # ph
                                which(tablon$nombres.indicadores=="Salinityrcp4.5 C"), # salinity
                                NA, # extreme
                                which(tablon$nombres.indicadores=="Riverrcp4.5 C"), # river
                                which(tablon$nombres.indicadores=="PLANKTONrcp4.5 C"))] # plankton
expositors.centre45 [which(is.na(expositors.centre45))] <- 1

expositors.centre85 <- tablon$multiplier.final [
                             c (which(tablon$nombres.indicadores=="SSTrcp8.5 C"), # sst
                                which(tablon$nombres.indicadores=="Ecurrentrcp8.5 C"), # currents EAST
                                which(tablon$nombres.indicadores=="PHrcp8.5 C"), # ph
                                which(tablon$nombres.indicadores=="Salinityrcp8.5 C"), # salinity
                                NA, # extreme
                                which(tablon$nombres.indicadores=="Riverrcp8.5 C"), # river
                                which(tablon$nombres.indicadores=="PLANKTONrcp8.5 C"))] # plankton
expositors.centre85 [which(is.na(expositors.centre85))] <- 1

expositors.south45 <- tablon$multiplier.final [
                             c (which(tablon$nombres.indicadores=="SSTrcp4.5 S"), # sst
                                which(tablon$nombres.indicadores=="NCurrentrcp4.5 S"), # currents EAST
                                which(tablon$nombres.indicadores=="PHrcp4.5 S"), # ph
                                which(tablon$nombres.indicadores=="Salinityrcp4.5 S"), # salinity
                                NA, # extreme
                                which(tablon$nombres.indicadores=="Riverrcp4.5 S"), # river
                                which(tablon$nombres.indicadores=="PLANKTONrcp4.5 S"))] # plankton
expositors.south45 [which(is.na(expositors.south45))] <- 1

expositors.south85 <- tablon$multiplier.final [
                             c (which(tablon$nombres.indicadores=="SSTrcp8.5 S"), # sst
                                which(tablon$nombres.indicadores=="Ncurrentrcp8.5 S"), # currents EAST
                                which(tablon$nombres.indicadores=="PHrcp8.5 S"), # ph
                                which(tablon$nombres.indicadores=="Salinityrcp8.5 S"), # salinity
                                NA, # extreme
                                which(tablon$nombres.indicadores=="Riverrcp8.5 S"), # river
                                which(tablon$nombres.indicadores=="PLANKTONrcp8.5 S"))] # plankton
expositors.south85 [which(is.na(expositors.south85))] <- 1

## expositors.north45 <- c(1,1,1,1,1,1,1)
## expositors.north85 <- c(1,1,1,1,1,1,1)
## expositors.centre45 <- c(1,1,1,1,1,1,1)
## expositors.centre85 <- c(1,1,1,1,1,1,1)
## expositors.south45 <- c(1,1,1,1,1,1,1)
## expositors.south85 <- c(1,1,1,1,1,1,1)

w.indicators <- read.csv ("~/CCMAR/JUAN/CLIMFISH/VULNERABILITY/IndicatorWeights.csv", sep=",")
order.w.indicators <- match (descriptores, as.character(unlist(c(w.indicators["R.name"]))) )
weights.indicators <- w.indicators [order.w.indicators, "WEIGHT"]
weights.indicators [1:7] <- 1 ## Exposure (for now)
weights.indicators [1:7] <- 1 ## Directional effects

## vulnerability function extracts the answers for a given species
analysis <- function (species="Anguilla anguilla NORTH")
{
    
    ## experts <- unique (expertos [grep ( "Callista", unlist(todo[1,]))]) 
    experts <- unique (expertos [grep ( substr(species, start=1, stop=nchar(species)-9), unlist(todo[1,]))])
    
    columns1 <-  grep (species, unlist(todo[1,]))     # columns values
    columns2 <-  grep (species, unlist(todo[1,])) + 1 # columns data quality

    tabla.sp <- todo [, c(rbind(columns1, columns2))]
    n.evaluations <- ncol(tabla.sp)/2

    ## DATA
    descriptor.values <- as.data.frame(matrix(NA, nrow=length(descriptores), ncol=n.evaluations)) 
    quality.values    <- as.data.frame(matrix(NA, nrow=length(descriptores), ncol=n.evaluations)) 
    rownames(descriptor.values) <- descriptores; rownames(quality.values) <- descriptores
    sequencia <- seq(4, 122, by=4)
    for (j in 1:length(descriptores))
    {
        filas <- c(sequencia[j]-1, sequencia[j], sequencia[j]+1)
        tablina <- matrix(as.numeric(as.matrix(tabla.sp [filas,])), nrow=3)

        tablina.values  <- tablina[,c(seq(from=1,to=ncol(tablina)-1,by=2))]
        tablina.quality <- tablina[,c(seq(from=2,to=ncol(tablina),by=2))]

        ## CONTROL TALLIES
        ## tls <- colSums(tablina.values, na.rm=TRUE)
        ## qlt <- colSums(tablina.quality, na.rm=TRUE)
        ## if ( tls[1] == 5 & tls[2] == 5 & tls[3] == 5 ) {
        ## } else {
        ##     experto.falhou <- experts [which(tls != c(5,5,5))]
        ##     print( paste(species, experto.falhou, paste (descriptores[j], ": Tallies do not sum 5")))}
        ## if ( qlt[1] == 0 | qlt[2] == 0 | qlt[3] == 0 ) {
        ##     experto.quality0 <- experts [which(tls == c(0,0,0))]
        ##     print ( paste(species, experto.quality0, paste (descriptores[j],"Quality = 0")))}
        
        ## IF THERE IS ONLY ONE EXPERTS VOTE FOT THE SPECIES
        if (n.evaluations == 1) {
            if (j < length(descriptores)) { ## no directional effect
                descriptor.values [j,1] <- sum (tablina [ ,1] * scores, na.rm=TRUE)
                quality.values [j,1] <- tablina.quality [1]}
            
            if (j == length(descriptores)) {
                descriptor.values [j,1] <- sum (tablina [ ,1] * scores.directional, na.rm=TRUE)
                quality.values [j,1] <- tablina.quality [1]}   
        }

        ## IF THERE IS MORE THAN ONE EXPERTS VOTE FOT THE SPECIES
        if (n.evaluations > 1) {
            
            if (j < length(descriptores)) { ## no directional effect
                for (i in 1:n.evaluations){
                    descriptor.values [j,i] <- sum (tablina.values [ ,i] * scores, na.rm=TRUE)
                    quality.values [j,i] <- tablina.quality [1 ,i]}
            }

            if (j == length(descriptores)) { ## directional effect
                for (i in 1:n.evaluations){
                    descriptor.values [j,i] <- sum (tablina.values [ ,i] * scores.directional, na.rm=TRUE)
                    quality.values [j,i] <- tablina.quality [1 ,i]}
            }
            
        }
    }

    ## Data from quality=0 became NA
    eliminar0quality <- which (quality.values==0, arr.ind=TRUE)
    descriptor.values [eliminar0quality] <- NA
            
    ## Average among the three/four experts
    descriptors.calculated <- rowMeans (descriptor.values, na.rm=TRUE)
     
    ## WEIGHTS: Correction of exposure according to Susan maps and Experts' criteria
    
    ## ## EXPOSURE
    region <- substr (species, start=unlist(gregexpr(pattern=" ", species))[2] + 1, stop=nchar(species))
    if (region == "NORTH")  {D45 <- expositors.north45 ; D85 <- expositors.north85}
    if (region == "CENTRE") {D45 <- expositors.centre45 ; D85 <- expositors.centre85}
    if (region == "SOUTH")  {D45 <- expositors.south45 ; D85 <- expositors.south85}
        
    ## ## SENSITIVITY AND AC
    weights.sensitivity <- weights.indicators [which(categorias=="Sensitivity")]
    weights.adaptive    <- weights.indicators [which(categorias=="Adaptive")]

    ## Apply weights
    correctoresD45 <- c(D45, weights.sensitivity, weights.adaptive, 1)
    correctoresD85 <- c(D85, weights.sensitivity, weights.adaptive, 1)
    
    descriptors.calculated45 <- descriptors.calculated * correctoresD45 ## atencion: valores absolutos de exposicion, no hay negativos
    descriptors.calculated85 <- descriptors.calculated * correctoresD85 ## atencion: valores absolutos de exposicion, no hay negativos    

    ## Standardize INDICATORS
    ## maximos.exposure.pairs <- rep (NA, length(D45))
    ## minimos.exposure.pairs <- rep (NA, length(D45))
    ## for (i in 1:length(D45))
    ## {maximos.exposure.pairs [i] <- max( c( D45[i], D85[i]))
    ##     minimos.exposure.pairs [i] <- min( c( D45[i], D85[i]))} 

    ## ATTENTION TO THE WAY STANDARDIZATION IS DONE:

    ## maximos.exposure <- 5 * 3 * maximos.exposure.pairs ## STANDARDIZED BY MAX AND MIN FROM PAIR 4.5 AND 8.5 
    ## minimos.exposure <- 5 * 1 * minimos.exposure.pairs ## STANDARDIZED BY MAX AND MIN FROM PAIR 4.5 AND 8.5

    maximos.exposure <- rep (5 * 3 * max( c( D45, D85)), length(Exposure))  ## STANDARDIZED BY MAX AND MIN FROM exposure MAX AND MIN considering both scenarios and indicators
    minimos.exposure <- rep (5 * 1 * min( c( D45, D85)), length(Exposure))  ## STANDARDIZED BY MAX AND MIN FROM exposure MAX AND MIN considering both scenarios and indicators 
        
    maximos.sensitivity <- rep (5 * 3 * max(weights.sensitivity), length(Sensitivity)) ## STANDARDIZED BY MAX AND MIN FROM SENSITIVITY MAX AND MIN 
    minimos.sensitivity <- rep (5 * 1 * min(weights.sensitivity), length(Sensitivity)) ## STANDARDIZED BY MAX AND MIN FROM SENSITIVITY MAX AND MIN
    
    maximos.adaptive <- rep (5 * 3 * max(weights.adaptive), length(Adaptive)) ## STANDARDIZED BY MAX AND MIN FROM ADAPTIVE MAX AND MIN
    minimos.adaptive <- rep (5 * 1 * min(weights.adaptive), length(Adaptive)) ## STANDARDIZED BY MAX AND MIN FROM ADAPTIVE MAX AND MIN

    maximo.directional <- 5 * 1
    minimo.directional <- 5 * -1
    
    exposure.45.std <- rep (NA, length(D45))
    exposure.85.std <- rep (NA, length(D85))
    sensitivity.std <- rep (NA, length(weights.sensitivity))
    adaptive.std    <- rep (NA, length(weights.adaptive))
        
    for (i in 1:length(D45))
    {
        exposure.45.std [i] <- (1 - 0) * ((descriptors.calculated45 [which(categorias=="Exposure")][i] - minimos.exposure[i]) / (maximos.exposure[i] - minimos.exposure[i])) + 0
        exposure.85.std [i] <- (1 - 0) * ((descriptors.calculated85 [which(categorias=="Exposure")][i] - minimos.exposure[i]) / (maximos.exposure[i] - minimos.exposure[i])) + 0}
    
    for (i in 1:length(weights.sensitivity))
    {
        sensitivity.std [i] <- (1 - 0) * ((descriptors.calculated45 [which(categorias=="Sensitivity")][i] - minimos.sensitivity[i]) / (maximos.sensitivity[i] - minimos.sensitivity[i])) + 0}

    for (i in 1:length(weights.adaptive))
    {
        adaptive.std [i] <- (1 - 0) * ((descriptors.calculated45 [which(categorias=="Adaptive")][i] - minimos.adaptive[i]) / (maximos.adaptive[i] - minimos.adaptive[i])) + 0}
    
    directional.std <- (1 - -1) * ((descriptors.calculated45 [which(categorias=="Directional")] - minimo.directional) / (maximo.directional - minimo.directional)) + -1


    ## Descriptors standardized
    descriptors45.std <- c (exposure.45.std, sensitivity.std, adaptive.std, directional.std) ; names(descriptors45.std) <- descriptores
    descriptors85.std <- c (exposure.85.std, sensitivity.std, adaptive.std, directional.std) ; names(descriptors85.std) <- descriptores
    
    ## CALCULATE CATEGORY VALUES
    EXPOSURE45.std <- sum (exposure.45.std, na.rm=TRUE) / length(which(!is.na(exposure.45.std))) ## DO NOT DIVIDE BY sum (D45)
    EXPOSURE85.std <- sum (exposure.85.std, na.rm=TRUE) / length(which(!is.na(exposure.85.std)))

    SENSITIVITY.std <- sum (sensitivity.std, na.rm=TRUE) / length(which(!is.na(sensitivity.std)))
    
    ADAPTIVE.std <- sum (adaptive.std, na.rm=TRUE) / length(which(!is.na(adaptive.std)))

    DIRECTIONAL.std <- directional.std
    
    categories.std45 <- c(EXPOSURE45.std, SENSITIVITY.std, ADAPTIVE.std, DIRECTIONAL.std)
    categories.std85 <- c(EXPOSURE85.std, SENSITIVITY.std, ADAPTIVE.std, DIRECTIONAL.std)
    names(categories.std45) <- c("Exposure", "Sensitivity", "Adaptive", "Directional")
    names(categories.std85) <- c("Exposure", "Sensitivity", "Adaptive", "Directional")
    
    exposure45    <- categories.std45 ["Exposure"]
    sensitivity45 <- categories.std45 ["Sensitivity"]
    directional45 <- categories.std45 ["Directional"]
    adaptive45    <- categories.std45 ["Adaptive"]

    exposure85    <- categories.std85 ["Exposure"]
    sensitivity85 <- categories.std85 ["Sensitivity"]
    directional85 <- categories.std85 ["Directional"]
    adaptive85    <- categories.std85 ["Adaptive"]

    ## OVERALL VULNERABILITY
    vulnerability45 <- as.numeric ((exposure45 + sensitivity45) - adaptive45)
    vulnerability85 <- as.numeric ((exposure85 + sensitivity85) - adaptive85)

    ## Text and bibliography
    texto <- as.character(tabla.sp [123,1])
    bibliografia <- as.character(tabla.sp [124,1])

    return(list("vulnerability45"=vulnerability45, "exposure45"=exposure45,
                "sensitivity45"=sensitivity45, "adaptive45"=adaptive45,
                "directional45"=directional45,

                "vulnerability85"=vulnerability85, "exposure85"=exposure85,
                "sensitivity85"=sensitivity85, "adaptive85"=adaptive85,
                "directional85"=directional85,

                "categories.std45"=categories.std45, "categories.std85"=categories.std85,
                "descriptors"=descriptor.values, "quality.values"=quality.values,
                "n.evaluations"=n.evaluations,
                "descriptors.calculated45"=descriptors.calculated45,
                "descriptors.calculated85"=descriptors.calculated85,
                "descriptors45.std"=descriptors45.std,
                "descriptors85.std"=descriptors85.std,
                "correctores45"=correctoresD45,
                "correctores85"=correctoresD85,
                "experts"=experts,

                "texto"=texto,
                "bibliografia"=bibliografia))
}
